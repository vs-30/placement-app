{% extends "layout.html" %}
{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">ðŸ“… Your Personalized Roadmap</h2>

  <!-- Roadmap Form -->
  <form action="{{ url_for('generate_roadmap') }}" method="POST" class="mb-5">
    <div class="row mb-3">
      <div class="col">
        <label for="weeks">Number of Weeks:</label>
        <input type="number" name="weeks" id="weeks" class="form-control" min="1" required
               value="{{ weeks or '' }}">
      </div>
      <div class="col">
        <label for="hours_per_week">Hours per Week:</label>
        <input type="number" name="hours_per_week" id="hours_per_week" class="form-control" min="1" required
               value="{{ hours_per_week or '' }}">
      </div>
    </div>
    <div class="mb-3">
      <label>Topics:</label><br>
      {% for topic in topics_list %}
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="topics" value="{{ topic }}"
                 {% if topic in selected_topics %}checked{% endif %}>
          <label class="form-check-label">{{ topic }}</label>
        </div>
      {% endfor %}
    </div>
    <button type="submit" class="btn btn-primary">Generate Roadmap</button>
  </form>

  {% if roadmap %}
    {% for week, questions in roadmap.items() %}
      <div class="card mb-4 week-card p-3">
        <h4 class="week-header">Week {{ week }}</h4>
        <hr>
        {% for q in questions %}
          <div class="question-item mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5>{{ q['title'] }}</h5>
                <p>
                  <strong>Topic:</strong> {{ q['topic'] }} |
                  <strong>Difficulty:</strong> {{ q['difficulty'] }} |
                  <strong>Expected Time:</strong> {{ q['expected_time_min'] }} min
                </p>
              </div>
              <button 
                class="btn btn-sm complete-btn {% if q['completed'] %}btn-success{% else %}btn-outline-secondary{% endif %}" 
                data-title="{{ q['title'] }}">
                {% if q['completed'] %}âœ… Completed{% else %}Mark Complete{% endif %}
              </button>
            </div>

            <div class="timer mb-2" id="timer-{{ week }}-{{ loop.index }}">00:00</div>
            <button class="btn btn-start" onclick="startTimer('{{ week }}-{{ loop.index }}')">Start</button>
            <button class="btn btn-pause" onclick="pauseTimer('{{ week }}-{{ loop.index }}')">Pause / Resume</button>
            <button class="btn btn-stop" onclick="stopTimer('{{ week }}-{{ loop.index }}')">Stop</button>
            {% if q['link'] %}
              <a href="{{ q['link'] }}" target="_blank" class="btn btn-info">View</a>
            {% endif %}

            <form action="{{ url_for('submit_time') }}" method="POST" style="display:none;" id="form-{{ week }}-{{ loop.index }}">
              <input type="hidden" name="week" value="{{ week }}">
              <input type="hidden" name="topic" value="{{ q['topic'] }}">
              <input type="hidden" name="question" value="{{ q['title'] }}">
              <input type="hidden" name="difficulty" value="{{ q['difficulty'] }}">
              <input type="hidden" name="expected_time" value="{{ q['expected_time_min'] }}">
              <input type="hidden" name="actual_time" id="actual-{{ week }}-{{ loop.index }}">
              <button type="submit" class="btn btn-submit mt-2">Submit</button>
            </form>
          </div>
          <hr>
        {% endfor %}
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">
      No roadmap generated yet. Please select the number of weeks, hours per week, and topics, then click "Generate Roadmap".
    </div>
  {% endif %}
</div>

<style>
.week-card { background: #fefefe; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.week-header { color: #5a3eeb; font-weight: bold; }
.timer { font-weight: 600; font-size: 16px; }
.btn { margin-right: 5px; margin-top: 5px; }
.btn-start { background: #4CAF50; color: white; }
.btn-pause { background: #ff9800; color: white; }
.btn-stop { background: #f44336; color: white; }
.btn-submit { background: #6c5ce7; color: white; }
.btn-info { background: #00bcd4; color: white; }
</style>

<script>
let timers = {};

// =============== TIMER LOGIC ===============
function startTimer(id) {
  if (!timers[id]) {
    timers[id] = {seconds: 0, running: false, interval: null};
  }
  if (!timers[id].running) {
    timers[id].running = true;
    timers[id].interval = setInterval(() => {
      timers[id].seconds++;
      document.getElementById("timer-" + id).innerText = formatTime(timers[id].seconds);
    }, 1000);
  }
}

function pauseTimer(id) {
  if (timers[id] && timers[id].running) {
    clearInterval(timers[id].interval);
    timers[id].running = false;
  } else if (timers[id] && !timers[id].running) {
    startTimer(id);
  }
}

function stopTimer(id) {
  if (timers[id]) {
    clearInterval(timers[id].interval);
    timers[id].running = false;
    document.getElementById("actual-" + id).value = timers[id].seconds;
    document.getElementById("form-" + id).style.display = "block";
  }
}

function formatTime(seconds) {
  let m = Math.floor(seconds / 60);
  let s = seconds % 60;
  return String(m).padStart(2, '0') + ":" + String(s).padStart(2, '0');
}

// =============== REAL-TIME UPDATE LOGIC ===============
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".complete-btn").forEach(btn => {
    btn.addEventListener("click", async function () {
      const title = this.dataset.title;
      this.disabled = true;

      const response = await fetch("/toggle_completed", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title })
      });

      const data = await response.json();
      if (data.status === "success") {
        if (data.completed) {
          this.innerHTML = "âœ… Completed";
          this.classList.add("btn-success");
          this.classList.remove("btn-outline-secondary");
        } else {
          this.innerHTML = "Mark Complete";
          this.classList.remove("btn-success");
          this.classList.add("btn-outline-secondary");
        }

        // Notify self_confidence.html to refresh
        localStorage.setItem("update_self_confidence", Date.now());
        this.disabled = false;
      } else {
        alert("Error updating status: " + data.message);
        this.disabled = false;
      }
    });
  });
});
</script>
{% endblock %}
