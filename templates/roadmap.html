{% extends "layout.html" %}
{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">ðŸ“… Create Your Personalized Roadmap</h2>

  <!-- Roadmap Form -->
  <form action="{{ url_for('generate_roadmap') }}" method="POST" class="mb-5">
    <div class="row mb-3">
      <div class="col">
        <label for="weeks">Number of Weeks:</label>
        <input type="number" name="weeks" id="weeks" class="form-control" min="1" required
               value="{{ request.form.get('weeks', '') }}">
      </div>
      <div class="col">
        <label for="hours_per_week">Hours per Week:</label>
        <input type="number" name="hours_per_week" id="hours_per_week" class="form-control" min="1" required
               value="{{ request.form.get('hours_per_week', '') }}">
      </div>
    </div>
    <div class="mb-3">
      <label>Topics:</label>
      <select name="topics" class="form-control" multiple required>
        {% for topic in topics_list %}
          <option value="{{ topic }}" {% if topic in selected_topics %}selected{% endif %}>{{ topic }}</option>
        {% endfor %}
      </select>
    </div>
    <button type="submit" class="btn btn-primary">Generate Roadmap</button>
  </form>

  {% if roadmap %}
    <!-- Display roadmap only if available -->
    {% for week, questions in roadmap.items() %}
      <div class="week-section">
        <div class="week-header">Week {{ week }}</div>

        {% for q in questions %}
          <div class="question-card">
            <h5>{{ q['title'] }}</h5>
            <p><strong>Topic:</strong> {{ q['topic'] }} | <strong>Difficulty:</strong> {{ q['difficulty'] }}</p>
            <p><strong>Expected Time:</strong> {{ q['expected_time_min'] }} min</p>

            <div class="timer" id="timer-{{ week }}-{{ loop.index }}">00:00</div>

            <button class="btn btn-start" onclick="startTimer('{{ week }}-{{ loop.index }}')">Start</button>
            <button class="btn btn-pause" onclick="pauseTimer('{{ week }}-{{ loop.index }}')">Pause / Resume</button>
            <button class="btn btn-stop" onclick="stopTimer('{{ week }}-{{ loop.index }}')">Stop</button>

            <form action="{{ url_for('submit_time') }}" method="POST" style="display:none;" id="form-{{ week }}-{{ loop.index }}">
              <input type="hidden" name="week" value="{{ week }}">
              <input type="hidden" name="topic" value="{{ q['topic'] }}">
              <input type="hidden" name="question" value="{{ q['title'] }}">
              <input type="hidden" name="difficulty" value="{{ q['difficulty'] }}">
              <input type="hidden" name="expected_time" value="{{ q['expected_time_min'] }}">
              <input type="hidden" name="actual_time" id="actual-{{ week }}-{{ loop.index }}">
              <button type="submit" class="btn btn-submit">Submit</button>
            </form>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">
      No roadmap generated yet. Please select the number of weeks, hours per week, and topics, then click "Generate Roadmap".
    </div>
  {% endif %}
</div>

<script>
let timers = {};

function startTimer(id) {
  if (!timers[id]) {
    timers[id] = {seconds: 0, running: false, interval: null};
  }
  if (!timers[id].running) {
    timers[id].running = true;
    timers[id].interval = setInterval(() => {
      timers[id].seconds++;
      document.getElementById("timer-" + id).innerText = formatTime(timers[id].seconds);
    }, 1000);
  }
}

function pauseTimer(id) {
  if (timers[id] && timers[id].running) {
    clearInterval(timers[id].interval);
    timers[id].running = false;
  } else if (timers[id] && !timers[id].running) {
    startTimer(id);
  }
}

function stopTimer(id) {
  if (timers[id]) {
    clearInterval(timers[id].interval);
    timers[id].running = false;
    document.getElementById("actual-" + id).value = timers[id].seconds;
    document.getElementById("form-" + id).style.display = "block";
  }
}

function formatTime(seconds) {
  let m = Math.floor(seconds / 60);
  let s = seconds % 60;
  return String(m).padStart(2, '0') + ":" + String(s).padStart(2, '0');
}
</script>
{% endblock %}
