{% extends "layout.html" %}
{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">ðŸ“… Your Personalized Roadmap</h2>

  <!-- Roadmap Form -->
  <form action="{{ url_for('generate_roadmap') }}" method="POST" class="mb-5">
    <div class="row mb-3">
      <div class="col">
        <label for="weeks">Number of Weeks:</label>
        <input type="number" name="weeks" id="weeks" class="form-control" min="1" required
               value="{{ weeks or '' }}">
      </div>
      <div class="col">
        <label for="hours_per_week">Hours per Week:</label>
        <input type="number" name="hours_per_week" id="hours_per_week" class="form-control" min="1" required
               value="{{ hours_per_week or '' }}">
      </div>
    </div>
    <div class="mb-3">
      <label>Topics:</label><br>
      <div class="d-flex flex-wrap">
        {% for topic in topics_list %}
          <div class="topic-card m-2 p-2 text-center {% if topic in selected_topics %}selected{% endif %}" 
               onclick="toggleTopic(this)">
            {{ topic }}
            <input type="checkbox" name="topics" value="{{ topic }}" class="d-none" {% if topic in selected_topics %}checked{% endif %}>
          </div>
        {% endfor %}
      </div>
    </div>
    <button type="submit" class="btn btn-primary">Generate Roadmap</button>
  </form>

  {% if roadmap %}
    {% for week, questions in roadmap.items() %}
      <div class="card mb-4 week-card p-3">
        <h4 class="week-header">Week {{ week }}</h4>
        <hr>
        {% for q in questions %}
          <div class="question-item mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5>{{ q['title'] }}</h5>
                <p>
                  <strong>Topic:</strong> {{ q['topic'] }} |
                  <strong>Difficulty:</strong> {{ q['difficulty'] }} |
                  <strong>Expected Time:</strong> {{ q['expected_time_min'] }} min
                </p>
              </div>
              <button 
                class="btn btn-sm complete-btn {% if q['completed'] %}btn-success{% else %}btn-outline-secondary{% endif %}" 
                data-title="{{ q['title'] }}">
                {% if q['completed'] %}âœ… Completed{% else %}Mark Complete{% endif %}
              </button>
            </div>

            <div class="timer mb-2" id="timer-{{ week }}-{{ loop.index }}">00:00</div>
            <button class="btn btn-start" onclick="startTimer('{{ week }}-{{ loop.index }}')">Start</button>
            <button class="btn btn-pause" onclick="pauseTimer('{{ week }}-{{ loop.index }}')">Pause / Resume</button>
            <button class="btn btn-stop" onclick="submitTime('{{ week }}-{{ loop.index }}', '{{ q['title'] }}', '{{ q['topic'] }}', '{{ q['expected_time_min'] }}')">Stop</button>
            {% if q['link'] %}
              <a href="{{ q['link'] }}" target="_blank" class="btn btn-info">View</a>
            {% endif %}
          </div>
          <hr>
        {% endfor %}
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">
      No roadmap generated yet. Please select the number of weeks, hours per week, and topics, then click "Generate Roadmap".
    </div>
  {% endif %}
</div>

<style>
/* Flashcard style for topics */
.topic-card { 
  border: 1px solid #ccc; 
  border-radius: 12px; 
  padding: 10px 20px; 
  cursor: pointer; 
  user-select: none;
  background: #fefefe;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
}
.topic-card.selected {
  background: #5a3eeb;
  color: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.week-card { background: #fefefe; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.week-header { color: #5a3eeb; font-weight: bold; }
.timer { font-weight: 600; font-size: 16px; }
.btn { margin-right: 5px; margin-top: 5px; }
.btn-start { background: #4CAF50; color: white; }
.btn-pause { background: #ff9800; color: white; }
.btn-stop { background: #f44336; color: white; }
.btn-submit { background: #6c5ce7; color: white; }
.btn-info { background: #00bcd4; color: white; }
</style>

<script>
let timers = {}; // will store startTime and pausedSeconds for each question

function startTimer(id) {
  if (!timers[id]) {
    timers[id] = { startTime: Date.now(), pausedSeconds: 0, running: true };
  } else if (!timers[id].running) {
    // Resume from pause
    timers[id].startTime = Date.now() - timers[id].pausedSeconds * 1000;
    timers[id].running = true;
  }
  updateTimer(id);
}

function pauseTimer(id) {
  if (timers[id] && timers[id].running) {
    timers[id].pausedSeconds = Math.floor((Date.now() - timers[id].startTime) / 1000);
    timers[id].running = false;
  }
}

function updateTimer(id) {
  if (!timers[id] || !timers[id].running) return;
  const elapsedSeconds = Math.floor((Date.now() - timers[id].startTime) / 1000);
  document.getElementById("timer-" + id).innerText = formatTime(elapsedSeconds);
  requestAnimationFrame(() => updateTimer(id)); // smooth and accurate
}

function formatTime(seconds) {
  let m = Math.floor(seconds / 60);
  let s = seconds % 60;
  return String(m).padStart(2, '0') + ":" + String(s).padStart(2, '0');
}

// =============== ASYNC SUBMIT FUNCTION ===============
function submitTime(id, questionTitle, topic, expectedTime) {
  let actualTime = 0;
  if (timers[id]) {
    actualTime = timers[id].running
      ? Math.floor((Date.now() - timers[id].startTime) / 1000)
      : timers[id].pausedSeconds;
    timers[id].running = false; // stop timer
  }

  fetch("/submit_time_ajax", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      question: questionTitle,
      topic: topic,
      actual_time: actualTime,
      expected_time: expectedTime
    })
  })
  .then(res => res.json())
  .then(data => {
    if(data.status === "success"){
      const btn = document.querySelector(`.complete-btn[data-title='${questionTitle}']`);
      if(btn){
        btn.innerHTML = "âœ… Completed";
        btn.classList.add("btn-success");
        btn.classList.remove("btn-outline-secondary");
      }
    } else {
      alert("Error saving time");
    }
  });
}


// =============== REAL-TIME TOGGLE COMPLETED ===============
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".complete-btn").forEach(btn => {
    btn.addEventListener("click", async function () {
      const title = this.dataset.title;
      this.disabled = true;

      const response = await fetch("/toggle_completed", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title })
      });

      const data = await response.json();
      if (data.status === "success") {
        if (data.completed) {
          this.innerHTML = "âœ… Completed";
          this.classList.add("btn-success");
          this.classList.remove("btn-outline-secondary");
        } else {
          this.innerHTML = "Mark Complete";
          this.classList.remove("btn-success");
          this.classList.add("btn-outline-secondary");
        }

        localStorage.setItem("update_self_confidence", Date.now());
        this.disabled = false;
      } else {
        alert("Error updating status: " + data.message);
        this.disabled = false;
      }
    });
  });
});
</script>
{% endblock %}
