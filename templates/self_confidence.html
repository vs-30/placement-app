{% extends "layout.html" %}
{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">ðŸ’ª Your Self-Confidence Report</h2>

  {% for topic, questions in performance_by_topic.items() %}
    <div class="card mb-4 topic-card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="topic-header">{{ topic }}</h4>
        <span class="badge bg-primary">{{ questions|selectattr("status","equalto","Completed On Time")|list|length }}/{{ questions|length }} Completed</span>
      </div>
      <button class="btn btn-sm btn-outline-secondary mt-2 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false">
        View Incomplete Questions
      </button>
      <div class="collapse" id="collapse-{{ loop.index }}">
        {% for q in questions %}
          {% if q.status != "Completed On Time" %}
            <div class="question-item mb-2 p-2 border rounded">
              <h5>{{ q.title }}</h5>
              <p><strong>Status:</strong> 
                {% if q.status == "Exceeded Expected Time" %}
                  <span style="color:orange;">{{ q.status }}</span>
                {% else %}
                  <span style="color:red;">{{ q.status }}</span>
                {% endif %}
              </p>
              <p><strong>Expected Time:</strong> {{ q.expected_time }} min | 
                 <strong>Actual Time:</strong> {{ q.actual_time if q.actual_time else 'Not Attempted' }}</p>
              {% if q.link %}
                <a href="{{ q.link }}" target="_blank" class="btn btn-info btn-sm">View Question</a>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<style>
.topic-card { background: #fefefe; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.topic-header { color: #5a3eeb; font-weight: bold; }
.question-item { padding: 8px; }
.btn-info { background: #00bcd4; color: white; }
</style>

<script>
/* =============== AUTO REFRESH ON UPDATE =============== */
window.addEventListener('storage', function(e) {
  if (e.key === 'update_self_confidence') {
    location.reload();
  }
});
</script>
{% endblock %}
